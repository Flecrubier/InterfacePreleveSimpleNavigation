<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-multiupload.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-upload-task.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-ref.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-group.html">
<link rel="import" href="../../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/geo-location/geo-location.html">
<link rel="import" href="shared-styles.html">

<dom-module id="viewreleves-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>

<!--Creation dialog-->

  <paper-alert-dialog
    id="dialogUpload0"
    title="Erreur d'upload"
    confirm-button="OK">
    Vous ne pouvez choisir que jusqu'a 3 images
  </paper-alert-dialog>

  <paper-alert-dialog
    id="dialogDelete0"
    title="Suppression relevé"
    confirm-button="Oui"
    dismiss-button="Non"
    on-confirm="confirmDelete">
    Voulez vous vraiment supprimmer ce relevé ?
  </paper-alert-dialog>

<!--Fin creation dialog-->

    <template is="dom-if" if="[[user]]">
      <geo-location watch-pos latitude="{{latitude}}" longitude="{{longitude}}"></geo-location>

      <h4>S'il n'y a pas de valeur pour la latitude/longitude veuillez actualiser dans quelques instants ou remplir le code postal</h4>
      <div>Latitude : [[latitude]]</div>
      <div>Longitude : [[longitude]]</div>

      <br/>
      <h5>Liste des relevés actuels :</h5>
      <paper-collapse-group>
        <template is="dom-repeat" items="[[datas]]">
          <paper-collapse-item id="item[[index]]" icon="icons:info" header="Relevé [[getIndex(index)]]">
            <div role="listbox">

              <paper-icon-item>
                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                <paper-item-body two-lines>
                  <div>Espèce</div>
                  <div secondary>[[item.espece]]</div>
                </paper-item-body>
              </paper-icon-item>

              <paper-icon-item>
                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                <paper-item-body two-lines>
                  <div>Famille</div>
                  <div secondary>[[item.famille]]</div>
                </paper-item-body>
              </paper-icon-item>

              <paper-icon-item>
                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                <paper-item-body two-lines>
                  <div>Longitude</div>
                  <div secondary>[[item.Longitude]]</div>
                </paper-item-body>
              </paper-icon-item>

              <paper-icon-item>
                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                <paper-item-body two-lines>
                  <div>Latitude</div>
                  <div secondary>[[item.Latitude]]</div>
                </paper-item-body>
              </paper-icon-item>

              <paper-icon-item>
                <iron-icon icon="image:image" slot="item-icon"></iron-icon>
                <paper-item-body two-lines>
                  <div>Image</div>
                  <div secondary><img src="[[item.URL_Image ]]"></img></div>
                </paper-item-body>
              </paper-icon-item>


              <paper-icon-item>
                <iron-icon icon="icons:delete-forever" slot="item-icon"></iron-icon>
                  <paper-button id="deleteReleveBtn[[index]]" raised on-tap="deleteReleve">Supprimmer</paper-button>
              </paper-icon-item>

            </div>
          </paper-collapse-item>
        </template>
      </paper-collapse-group>

      <br/>
      <h5>Ajouter un relevé :</h5>
      <paper-input style="width:20em" label="Nom de l'espèce" value="{{specie}}" maxlength="30"></paper-input>
      <paper-input style="width:20em" label="Nom de la famille" value="{{family}}" maxlength="30"></paper-input>
      <paper-input style="width:6em" id="CPInput" label="Code postal" value="{{codepostal}}" maxlength="5" disabled></paper-input>

      <paper-input style="width:20em" label="Images (3 max)" type="file" id="file-uploader" accept="image/*" multiple></paper-input>

      <firebase-storage-multiupload
        app-name="iPreleveFirebase"
        id="fs"
        path="/relevesImages/[[user.uid]]"
        ref="{{fsRef}}"
        files="[[files]]"
        upload-tasks="{{uploadTasks}}"
        on-error="_showError"
        force-unique>
      </firebase-storage-multiupload>

      <template is="dom-repeat" items="[[uploadTasks]]">
        <firebase-storage-upload-task
          app-name="iPreleveFirebase"
          task="[[item]]"
          id="ut-[[index]]"
          bytes-transferred="{{item.bytesTransferred}}"
          total-bytes="{{item.totalBytes}}"
          state="{{item.state}}"
          download-url="{{item.downloadUrl}}"
          metadata="{{item.metadata}}"
          path="{{item.path}}">
        </firebase-storage-upload-task>

        Etat : [[item.state]] <br>

        <template is="dom-if" if="[[!isEqual(item.state, 'success')]]">
          <paper-progress
            value="{{item.bytesTransferred}}"
            min="0"
            max="{{item.totalBytes}}">
          </paper-progress>
        </template>

      </template>

      <paper-button id="btnAddData" raised on-tap="_addData" style="visibility:hidden">Ajouter</paper-button>

    </template>

    <template is="dom-if" if="[[!user]]">
      <h4 style="color:red">Veuillez vous connecter afin de consulter vos relevés</h4>
    </template>

  </template>

  <script>
    class ViewRelevesApp extends Polymer.Element {
      static get is() { return 'viewreleves-app'; }

      static get properties(){
        return{
          nbTasks:{
            type:Number
          },
          datas:{
            type:Array,
          },
          eventBtn:{
            type:Object
          },
          doAdded:{
            type:Boolean
          },
          latitude:{
            type:Number,
          },
          longitude:{
            type:Number,
          },
          disabledCPInput:{
            type:Boolean,
          },
          CPInputReady:{
            type:Boolean,
          }
        }
      }

      static get observers(){
        return[
          "geoValueChanged(latitude, longitude, CPInputReady)"
        ];
      }

      constructor(){
        super();
        this.nbTasks=0;
        this.datas=[];
        this.doAdded = true;
        this.disabledCPInput = true;
        this.CPInputReady = false;
      }

      ready(){
        super.ready();

        this.CPInputReady = true;
        console.log("ready button ", this.shadowRoot.querySelector("#CPInput"));

        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser")
                      .on("child_added",snapshot =>{
                        if(this.doAdded){
                          var datasUnReleve = snapshot.val();
                          var unReleve = {
                            espece : datasUnReleve.espece,
                            famille : datasUnReleve.famille,
                            URL_Image : datasUnReleve.URL_Image,
                            Longitude : datasUnReleve.Longitude,
                            Latitude : datasUnReleve.Latitude
                          };
                          this.push("datas", unReleve);
                        }
          });

          firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser")
                      .on("child_removed", oldChildSnapshot=>{
                        if(this.doAdded){
                          var datasUnReleve = oldChildSnapshot.val();
                          var unReleve = {
                            espece : datasUnReleve.espece,
                            famille : datasUnReleve.famille,
                            URL_Image : datasUnReleve.URL_Image,
                            Longitude : datasUnReleve.Longitude,
                            Latitude : datasUnReleve.Latitude
                          };
                          var index = this.checkReleve(unReleve);
                          if(index > -1){
                              this.splice("datas", index, 1);
                          }
                        }
          });

          this.addEventListener("change", function(e){
            if(e.path[0].id == "file-uploader"){
              if(this.shadowRoot.querySelector("#file-uploader").inputElement.inputElement.files.length > 3){
                this.$.dialogUpload0.open();
                this.shadowRoot.querySelector("#file-uploader").inputElement.inputElement.value = ""; //Clean FileList
                console.log(this.shadowRoot.querySelector("#file-uploader").inputElement.inputElement.files.length);
              }else if(this.shadowRoot.querySelector("#file-uploader").inputElement.inputElement.files.length == 0){
                console.log("Aucun fichier sélectionné");
              }
          }
        });
      }

      geoValueChanged(latitude, longitude){
        console.log(this.shadowRoot.querySelector("#CPInput"));
        console.log(this.CPInputReady);
        if(this.CPInputReady == true){
          console.log("Lat : ", latitude, " |Long : ", longitude);
          if(latitude == null && longitude == null){
            this.shadowRoot.querySelector("#CPInput").setAttribute("disabled", true);
          }else{
            this.shadowRoot.querySelector("#CPInput").removeAttribute("disabled");
          }
        }
      }

      checkReleve(releve){
        for(var i = 0 ; i < this.datas.length ; i++){
          if ( (this.datas[i].Longitude === releve.Longitude) &&
            (this.datas[i].Latitude === releve.Latitude) &&
            (this.datas[i].espece === releve.espece) &&
            (this.datas[i].famille === releve.famille) &&
            (this.datas[i].URL_Image === releve.URL_Image) ){
              return i;
            }
        }
        return -1;
      }

      upload(){
        if(this.shadowRoot.querySelector("#file-uploader").files.length == 0){
          this.$.dialogUpload0.open();
          return 1;
        }else if(this.shadowRoot.querySelector("#file-uploader").files.length > 1){
          this.$.dialogUpload1.open();
          return 1;
        }else{
          this.shadowRoot.querySelector("#fs").upload(this.shadowRoot.querySelector("#file-uploader").files);
          return 0;
        }
      }

      _uploadTasksChanged(uploadTasks) {
      }

      onFileUpload(e) {
        this.files = e.target.files;
        this.shadowRoot.querySelector("#file-uploader").style.visibility = "hidden";
        this.shadowRoot.querySelector("#btnAddData").style.visibility = "visible";
      }

      isEqual(a, b) {
        return a === b;
      }

      _addData(){
        //Retrouver nombre de relevés puis faire un ref.child("reeleve"+nbReleve+1).set({donnée});
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/n"+this.datas.length).set({
          espece : this.specie,
          famille : this.family,
          Longitude : this.longitude,
          Latitude : this.latitude,
          URL_Image : this.shadowRoot.querySelector("#ut-"+ this.nbTasks).downloadUrl
        });
        this.nbTasks = this.nbTasks+1;
        this.shadowRoot.querySelector("#file-uploader").style.visibility = "visible";
        this.shadowRoot.querySelector("#btnAddData").style.visibility = "hidden";
      }

      getIndex(index){
        return index+1;
      }

      deleteReleve(event){
        this.eventBtn=event;
        this.$.dialogDelete0.open();
      }

      confirmDelete(){
        var chaineId = this.eventBtn.path[0].id;
        var idReleve = chaineId.substring("deleteReleveBtn".length);
        var idReleveInt = parseInt(idReleve);
        var wantedKey = "n"+idReleveInt;
        var wantedDownloadUrl = this.datas[idReleveInt].URL_Image;

        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/"+wantedKey).remove(function(e){
          console.log("Fichier supprimmé");
        });

        this.refreshDBKeyNames(idReleveInt);

        firebase.app("iPreleveFirebase").storage().refFromURL(wantedDownloadUrl).delete();
      }

      refreshDBKeyNames(idDelete){
        //--On n'exécute pas la code des on crées dans le ready pour le déplcement des données
        this.doAdded = false;
        //--
        for(var i = idDelete ; i < this.datas.length ; i++){
          firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/n"+(i+1)).on("child_added", snapshot =>{
            firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/n"+i+"/"+snapshot.key).set(snapshot.val());
            firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/n"+(i+1)+"/"+snapshot.key).set(null);
          });

          firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/releveUser/n"+(i+1)).off("child_added");
        }
        //--
        this.doAdded = true;
        //--
      }
    }

    window.customElements.define(ViewRelevesApp.is, ViewRelevesApp);
  </script>
</dom-module>
