<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-group.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="viewadmin-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px 20px;
      }
    </style>

    <!--Création dialog-->

    <paper-alert-dialog
      id="dialogDelete0"
      title="Suppression relevé"
      confirm-button="Oui"
      dismiss-button="Non"
      on-confirm="confirmDeleteReleve">
      Voulez vous vraiment supprimmer ce relevé ?
    </paper-alert-dialog>

    <paper-alert-dialog
      id="dialogDelete1"
      title="Suppression utilisateur"
      confirm-button="Oui"
      dismiss-button="Non"
      on-confirm="confirmDeleteUser">
      Voulez vous vraiment supprimmer cet utilisateur ?
    </paper-alert-dialog>



    <template is="dom-if" if="[[user]]">
      <div hidden$=[[!isAdmin]]>

        <h3>Interface administration</h3>
        Liste des utilisateurs

        <template is="dom-repeat" items="[[datas]]" as="aUser">

          <firebase-storage-multiupload
            app-name="iPreleveFirebase"
            id="storage[[aUser.$key]]"
            path="/relevesImages/[[aUser.$key]]"
            files="[[aUser.files]]"
            on-error="_showError">
          </firebase-storage-multiupload>

              <div class="card">
                <div role="listbox">
                  <!-- 1 -->
                  <paper-icon-item>
                    <iron-icon icon="social:person" slot="item-icon"></iron-icon>
                    <paper-item-body two-lines>
                      <div>[[aUser.mail]]</div>

                      <!--Compter le nombre de relevés-->
                      <div secondary>[[aUser.releves.length]] relevés</div>
                    </paper-item-body>
                  </paper-icon-item>
                <!-- /1 -->



                <!-- 2 -->


                <paper-item>
                  <paper-item-body two-lines>
                    <div>Relevés :</div>
                    <div secondary>
                      <paper-collapse-group>
                        <template is="dom-repeat" items="[[aUser.releves]]" as="relevesUser" index-as="indexReleves">

                          <paper-collapse-item id="relevesUsers[[indexReleves]]" icon="icons:info" header="Relevé [[getIndex(indexReleves)]]">
                            <div role="listbox">

                              <paper-icon-item>
                                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Espèce</div>
                                  <div secondary>[[relevesUser.espece]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Famille</div>
                                  <div secondary>[[relevesUser.famille]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Longitude</div>
                                  <div secondary>[[relevesUser.Longitude]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Latitude</div>
                                  <div secondary>[[relevesUser.Latitude]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="image:image" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Image</div>
                                  <div secondary><img src="[[relevesUser.URL_Image]]"></img></div>
                                </paper-item-body>
                              </paper-icon-item>


                              <paper-icon-item>
                                <iron-icon icon="icons:delete-forever" slot="item-icon"></iron-icon>
                                  <paper-button id="deleteUsersReleve[[index]]nb[[indexReleves]]" raised on-tap="deleteReleve">Supprimmer</paper-button>
                              </paper-icon-item>

                            </div>
                          </paper-collapse-item>

                        </template>
                      </paper-collapse-group>
                    </div>
                  </paper-item-body>
                </paper-item>


                      <!-- /2 -->




                      <!-- 3 -->

                       <!--Inclure fonction quand toggle-->
                  <!--
                <paper-toggle-button checked="[[aUser.isAdmin]]" toggles>Admin</paper-toggle-button>
              -->

                      <!-- /3 -->

                      <!-- 4 -->

              </br>

              <paper-button
                id="deleteUsers[[index]]"
                raised on-tap="deleteUser">
              Supprimmer utilisateur
            </paper-button>



            </div>
          </div>
        </template>
      </div>

      <div hidden$=[[isAdmin]]>
        <h3 style="color:red">Vous n'êtes pas administrateur et n'avez donc pas accès à cette page</h3>
      </div>
    </template>

    <template is="dom-if" if="[[!user]]">
      <h3 style="color:red">Veuillez vous connecter pour pouvoir accéder à cette page</h3>
    </template>

  </template>

  <script>
    class ViewAdminApp extends Polymer.Element {
      static get is() { return 'viewadmin-app'; }

      static get properties() {
        return {
          rootPath: String,
          admins:{
            type: Array,
            readOnly: true,
            notify: true,
          },
          isAdmin:{
            type:Boolean,
            value: false,
            notify: true,
          },
          user:{
            type: Object,
            observer: "_userChanged",
          },
          datas:{
            type:Array
          },
          eventBtn:{
            type:Object
          },
          doAdded:{
            type:Boolean
          }
        };
      }

      constructor(){
        super();
        this.datas = [];
        this.doAdded = true;
      }

      static get observers(){
        //return["callbackFunction(path)"" ici path c'est admins.length]
        return[
          "_adminsChanged(admins.length)",
        ]
      }

      ready(){
        super.ready();
        var adminsArray = ["8h0ysggfujREgFntRco5bjEoWCi1"];
        this.adminsHandler(adminsArray);

        //ref on child_added
        firebase.app("iPreleveFirebase").database().ref("/releves").on("child_added", snapshot =>{
          if(this.doAdded){
            var datasUnUser = snapshot.val();
            //Il faut créer un Array a partir de releveUser sinon pas de dom-repeat possible
            var releveUnUser = datasUnUser.releveUser;
            var arrayReleve = [];
            for(var item in releveUnUser){
              arrayReleve.push(releveUnUser[item]);
            }

            var unUser = {
              id : snapshot.key,
              mail : datasUnUser.mail,
              releves : arrayReleve
            };
            this.push("datas", unUser);
          }
        });

        //ref on child_deleted
        firebase.app("iPreleveFirebase").database().ref("/releves").on("child_removed", oldChildSnapshot =>{
          if(this.doAdded){
            var datasUnUser = oldChildSnapshot.val();
            console.log(datasUnUser);
          }
        });

        console.log(this.datas);
        for(var i = 0 ; i < this.datas.length ; i++){
          console.log(this.datas[i].id);
          firebase.app("iPreleveFirebase").database().ref("/releves/"+this.datas[i].id+"/releveUser")
                      .on("child_removed", oldChildSnapshot=>{
                        //if
                          var datasUnReleveUser = oldChildSnapshot.val();
                          console.log(datasUnReleveUser);
                          console.log(checkReleve(i, datasUnReleveUser));
                      });
        }
      }

      checkReleve(numUser, releve){

      }

      adminsHandler(admins){
        this._setAdmins(admins);
      }


      _adminsChanged(changeLength){
        if(this.user != null){
          this.isAdmin = this.checkIsAdmin();
        }
      }

      _userChanged(){
        if(this.admins != null && this.user != null){
          this.isAdmin = this.checkIsAdmin();
        }
      }

      checkIsAdmin(){
        return this.admins.includes(this.user.uid);
      }

      getIndex(index){
        return index + 1;
      }

      deleteReleve(event){
        this.eventBtn = event;
        this.$.dialogDelete0.open();
      }

      confirmDeleteReleve(){
        var chaineId = this.eventBtn.path[0].id.substring("deleteUsersReleve".length);
        var splitChaineId = chaineId.split("nb");

        var userId = splitChaineId[0];
        var numReleve = splitChaineId[1];
        var wantedKey = "n"+numReleve;
        var wantedDownloadUrl = this.datas[userId].releves[numReleve].URL_Image;

        //delete
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.datas[userId].id+"/releveUser/"+wantedKey).remove(function(e){
          console.log("Releves supprimmé");
        });

        //reordonner relevés
        this.updateDBKeyNames(userId, numReleve);

        //delete dans stockage
        firebase.app("iPreleveFirebase").storage().refFromURL(wantedDownloadUrl).delete();
      }

      updateDBKeyNames(numUser, idDelete){
        this.doAdded = false;

        var userId = this.datas[numUser].id;
        console.log("userId ", userId);
        console.log("numUser ", numUser);
        console.log("idDelete ", idDelete);
        console.log("length ", this.datas[numUser].releves.length);
        for(var i = idDelete ; i < this.datas[numUser].releves.length ; i++){
          firebase.app("iPreleveFirebase").database().ref("/releves/"+userId+"/releveUser/n"+(i+1)).on("child_added", snapshot =>{
            console.log("why ?");
            firebase.app("iPreleveFirebase").database().ref("/releves/"+userId+"/releveUser/n"+i+"/"+snapshot.key).set(snapshot.val());
            firebase.app("iPreleveFirebase").database().ref("/releves/"+userId+"/releveUser/n"+(i+1)+"/"+snapshot.key).set(null);
          });

          firebase.app("iPreleveFirebase").database().ref("/releves/"+userId+"/releveUser/n"+(i+1)).off("child_added");
        }

        this.doAdded = true;
      }

      deleteUser(item){
        console.log(item);
      }

      _showError(error){
        console.log(error);
      }

      getNbReleves(idUser, datas){
        //console.log("releves" + idUser);
        if(this.shadowRoot.querySelector("#releves" + idUser) != null){
          return this.shadowRoot.querySelector("#releves" + idUser).data.length;
        }else{
          return "inconnu";
        }

        /*if(datas != null || datas != undefined){
          return datas.length;
        }*/
      }
    }

    window.customElements.define(ViewAdminApp.is, ViewAdminApp);
  </script>
</dom-module>
