<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../../bower_components/paper-collapse-item/paper-collapse-group.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="viewadmin-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px 20px;
      }
    </style>

    <paper-alert-dialog
      id="dialogDelete0"
      title="Suppression relevé"
      confirm-button="Oui"
      dismiss-button="Non"
      on-confirm="confirmDeleteReleve">
      Voulez vous vraiment supprimmer ce relevé ?
    </paper-alert-dialog>

    <paper-alert-dialog
      id="dialogDelete1"
      title="Suppression utilisateur"
      confirm-button="Oui"
      dismiss-button="Non"
      on-confirm="confirmDeleteUser">
      Voulez vous vraiment supprimmer cet utilisateur ?
    </paper-alert-dialog>



    <template is="dom-if" if="[[user]]">
      <div hidden$=[[!isAdmin]]>

        <h3>Interface administration</h3>
        Liste des utilisateurs
        <!--query-->
        <firebase-query
          app-name="iPreleveFirebase"
          id="queryUsers"
          path="/releves"
          data="{{dataUsers}}">
        </firebase-query>

        <template is="dom-repeat" items="[[dataUsers]]" as="aUser">

          <firebase-storage-multiupload
            app-name="iPreleveFirebase"
            id="storage[[aUser.$key]]"
            path="/relevesImages/[[aUser.personalData.0.mail]]"
            files="[[aUser.files]]"
            on-error="_showError">
          </firebase-storage-multiupload>

            <firebase-query
              app-name="iPreleveFirebase"
              id="releves[[aUser.$key]]"
              path="/releves/[[aUser.$key]]"
              data="{{aUser.personalData}}">
            </firebase-query>
              <div class="card">
                <div role="listbox">
                  <!-- 1 -->
                  <paper-icon-item>
                    <iron-icon icon="social:person" slot="item-icon"></iron-icon>
                    <paper-item-body two-lines>
                      <div>[[aUser.personalData.0.mail]]</div>

                      <!--Compter le nombre de relevés-->
                      <div secondary>[[aUser.personalData.length]] relevés</div>
                    </paper-item-body>
                  </paper-icon-item>
                <!-- /1 -->



                <!-- 2 -->


                <paper-item>
                  <paper-item-body two-lines>
                    <div>Relevés :</div>
                    <div secondary>
                      <paper-collapse-group>
                        <template is="dom-repeat" items="[[aUser.personalData]]" as="relevesUser" index-as="indexReleves">

                          <paper-collapse-item id="relevesUsers[[indexReleves]]" icon="icons:info" header="Relevé [[getIndex(indexReleves)]]">
                            <div role="listbox">
                              <paper-icon-item>
                                <iron-icon icon="icons:mail" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Mail</div>
                                  <div secondary>[[relevesUser.mail]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Espèce</div>
                                  <div secondary>[[relevesUser.espece]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="icons:info-outline" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Famille</div>
                                  <div secondary>[[relevesUser.famille]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Longitude</div>
                                  <div secondary>[[relevesUser.Longitude]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="device:gps-fixed" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Latitude</div>
                                  <div secondary>[[relevesUser.Latitude]]</div>
                                </paper-item-body>
                              </paper-icon-item>

                              <paper-icon-item>
                                <iron-icon icon="image:image" slot="item-icon"></iron-icon>
                                <paper-item-body two-lines>
                                  <div>Image</div>
                                  <div secondary><img src="[[relevesUser.URL_Image ]]"></img></div>
                                </paper-item-body>
                              </paper-icon-item>


                              <paper-icon-item>
                                <iron-icon icon="icons:delete-forever" slot="item-icon"></iron-icon>
                                  <paper-button id="deleteUsersReleve[[aUser.$key]]index[[indexReleves]]" raised on-tap="deleteReleve">Supprimmer</paper-button>
                              </paper-icon-item>

                            </div>
                          </paper-collapse-item>

                        </template>
                      </paper-collapse-group>
                    </div>
                  </paper-item-body>
                </paper-item>


                      <!-- /2 -->




                      <!-- 3 -->

                       <!--Inclure fonction quand toggle-->
                  <!--
                <paper-toggle-button checked="[[aUser.isAdmin]]" toggles>Admin</paper-toggle-button>
              -->

                      <!-- /3 -->

                      <!-- 4 -->

              <paper-button
                id="deleteUsers[[index]]"
                raised on-tap="deleteUser">
              Supprimmer utilisateur
            </paper-button>



            </div>
          </div>
        </template>
      </div>

      <div hidden$=[[isAdmin]]>
        <h3 style="color:red">Vous n'êtes pas administrateur et n'avez donc pas accès à cette page</h3>
      </div>
    </template>

    <template is="dom-if" if="[[!user]]">
      <h3 style="color:red">Veuillez vous connecter pour pouvoir accéder à cette page</h3>
    </template>

  </template>

  <script>
    class ViewAdminApp extends Polymer.Element {
      static get is() { return 'viewadmin-app'; }

      static get properties() {
        return {
          rootPath: String,
          admins:{
            type: Array,
            readOnly: true,
            notify: true,
          },
          isAdmin:{
            type:Boolean,
            value: false,
            notify: true,
          },
          user:{
            type: Object,
            observer: "_userChanged",
          },
        };
      }

      static get observers(){
        //return["callbackFunction(path)"" ici path c'est admins.length]
        return[
          "_adminsChanged(admins.length)",
        ]
      }

      ready(){
        super.ready();
        var adminsArray = ["8h0ysggfujREgFntRco5bjEoWCi1"];
        this.adminsHandler(adminsArray);
      }

      adminsHandler(admins){
        this._setAdmins(admins);
      }


      _adminsChanged(changeLength){
        if(this.user != null){
          this.isAdmin = this.checkIsAdmin();
        }
      }

      _userChanged(){
        if(this.admins != null && this.user != null){
          this.isAdmin = this.checkIsAdmin();
        }
      }

      checkIsAdmin(){
        return this.admins.includes(this.user.uid);
      }

      getIndex(index){
        return index + 1;
      }

      deleteReleve(item){
        var chaineId = item.path[0].id.substring("deleteUsersReleve".length);
        var splitChaineId = chaineId.split("index");

        var userId = splitChaineId[0];
        var numReleve = parseInt(splitChaineId[1]);
        var wantedKey;
        var wantedDownloadUrl;
        var count = 0;

        var ref = this.shadowRoot.querySelector("#releves" + userId).ref;

        ref.orderByKey().limitToFirst(numReleve+1).on("child_added", function(snapshot){
          if(count != numReleve){ count++ ;}
          else{ wantedKey = snapshot.key;}
        });

        ref.child(wantedKey).on("child_removed", function(oldChildSnapshot){
          if(oldChildSnapshot.key === "URL_Image"){
            wantedDownloadUrl = oldChildSnapshot._e.T;
          }
        });

        ref.child(wantedKey).remove(function(e){
          console.log("Fichier supprimmé");
        });

        console.log(wantedKey);
        console.log(wantedDownloadUrl);
        this.shadowRoot.querySelector("#storage" + userId).storage.refFromURL(wantedDownloadUrl).delete();

      }

      deleteUser(item){
        console.log(item);
      }

      _showError(error){
        console.log(error);
      }
    }

    window.customElements.define(ViewAdminApp.is, ViewAdminApp);
  </script>
</dom-module>
